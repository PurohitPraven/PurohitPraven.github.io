<!DOCTYPE html>
<html>

<link href='https://fonts.googleapis.com/css?family=Lato:300,900' rel='stylesheet' type='text/css'>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style>
    /*circle {fill: lightblue; stroke: darkred;}*/
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 80px;
        height: 22px;
        padding: 2px;
        font: 9px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    svg {
        background-color: white;
        font-family: 'Lato';
    }

    .annotation-group, text.title {
        font-size: .7em;
    }

    text.title {
        font-size: .8em;
    }
</style>
<body onload='init()'>

<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<h1> GDP vs Life expectancy for counties, and how it has changed over years</h1><br/>
<svg width=1300 height=900>

</svg>
<script>

    let regions = []
    let selected_regions = []
    let years = ["<-Prev", 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, "Next->"]
    let select_year = 2005
    let csv_data, xs, ys, cs = null

    async function init() {
    d3.csv("https://purohitpraven.github.io/Worldbank_GDP related data.csv")
        .then(function(data) {
            let margin = 60
            let svg_dim = 1200-500
            let max_gdp = 0
            let max_lifeexp = 0

            csv_data = data

            const annotations = [
                 {
                    type: d3.annotationXYThreshold,
                    note: {
                        label: "Sub-Saharan African countries have lower life expectancy and lower GDP. Even when GDP is high, life expectancy doesnt show a corresponding increase",
                        title: "Sub-Saharan Africa",
                        wrap: 190
                    },
                    /*connector: {
                        end: "dot",
                        type: "curve",
                        //can also add a curve type, e.g. curve: d3.curveStep
                        points: [[100, 14],[190, 52]]
                    },*/
                    //settings for the subject, in this case the circle radius
                    subject: {
                        x1: 70,
                        x2: 450
                    },
                    x: 190,
                    y: 260,
                    dy: -70,
                    dx: 20
                },
                {
                    type: d3.annotationXYThreshold,
                    note: {
                        label: "North American countries are at the top of the spectrum for GDP and Life expectancy",
                        title: "North America",
                        wrap: 190
                    },
                    subject: {
                        y1: 130,
                        y2: 240
                    },
                    x: 790,
                    y: 180,
                    dy: 30,
                    dx: 40
                },
                {
                    type: d3.annotationXYThreshold,
                    note: {
                        label: "Rest of the regions are speread across from 60 years to 85 years for Life expectancy, and are not at the bottom of the spectrum for GDP",
                        title: "Rest of the Regions",
                        wrap: 340
                    },
                    subject: {
                        x1: 400,
                        x2: 740
                    },
                    x: 650,
                    y: 80,
                    dy: 30,
                    dx: 190
                },
                {
                    type: d3.annotationXYThreshold,
                    note: {
                        label: "We notice 2 trends. (1) Generally as years progress, the GDP of countries increases and life expectancy increases. " +
                               "     (2) Countries that have higher GDP seem to have higher life expectancy",
                        title: "Trend",
                        wrap: 340
                    },
                    subject: {
                        y1: 100,
                        y2: 740
                    },
                    x: 750,
                    y: 400,
                    dy: 30,
                    dx: 90
                },
                {
                    type: d3.annotationXYThreshold,
                    note: {
                        label: "Click Next or previous to see changes in GDP and Life Expectancy over years, or select an year by clicking on it",
                        title: "Slide Show",
                        wrap: 340
                    },
                    subject: {
                        y1: 0,
                        y2: 30
                    },
                    x: 770,
                    y: 10,
                    dy: 30,
                    dx: 40
                },
                {
                    type: d3.annotationXYThreshold,
                    note: {
                        label: "Select different regions to see region specific spreads",
                        title: "Legend",
                        wrap: 140
                    },
                    subject: {
                        y1: 600,
                        y2: 740
                    },
                    x: 1020,
                    y: 660,
                    dy: 10,
                    dx: 10
                }].map(function(d){ d.color = "#E8336D"; return d})

            const makeAnnotations = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations)


            clear_all = []
            d3.selectAll("g").data(clear_all).exit().remove()

            //find minimum and maximum for GDP and Life Expectancy to use for axis limits

            for(i=0; i<data.length; i++){
                gdp = Number(data[i]["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"]);
                lifeexp = Number(data[i]["Life expectancy at birth, total (years) [SP.DYN.LE00.IN]"]);
                if(gdp > max_gdp) max_gdp = gdp;
                if(lifeexp>max_lifeexp) max_lifeexp = lifeexp;
            }

            let min_gdp = max_gdp
            let min_lifeexp = max_lifeexp

            for(i=0; i<data.length; i++){
                let gdp = Number(data[i]["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"]);
                let lifeexp = Number(data[i]["Life expectancy at birth, total (years) [SP.DYN.LE00.IN]"]);

                if(gdp < min_gdp) min_gdp = gdp;
                if(lifeexp < min_lifeexp) min_lifeexp = lifeexp;
            }

            min_gdp = min_gdp - (min_gdp%100)
            min_lifeexp = min_lifeexp - (min_lifeexp%10)

            regions = d3.map(data, function(d){return d.Region;}).keys()
            selected_regions = [...regions]

            xs = d3.scaleLinear().domain([min_lifeexp,max_lifeexp]).range([0,svg_dim]);
            ys = d3.scaleLog().domain([min_gdp,max_gdp]).range([svg_dim,0]);
            //cs = d3.scaleOrdinal().domain(regions).range(["blue", "green", "black", "red", "darkorange", "darkred", "grey"])
            cs = d3.scaleOrdinal().domain(regions).range(d3.schemeTableau10)//d3.schemeCategory10)


            d3.select("svg")
                .selectAll("g")
                .data(years)
                .enter()
                .append("g")
                .attr("transform", function(d, i) { return "translate(" + (i*58) + ",20)"; })
                .append("text").text(function(d,i){return(years[i])})

            // Define the div for the tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            //Add years as rectangles and onclick logic to change chart
            d3.select("svg")
                .selectAll("g")
                .each(function(d, i)
                {
                    d3.select(this).append("rect")
                        .attr("id", "year"+String(d))
                        .attr('x', -5)
                        .attr('y', -15)
                        .attr('opacity', .2)
                        .attr('width', 55)
                        .attr('height', 20)
                        .attr('stroke', 'black')
                        .attr('fill', function(d,i)
                        {
                            if(d=="<-Prev" || d=="Next->") return("yellow")
                            if(Number(d)===2005) return('blue');
                            else return ('red');
                        })
                        .on('click', function(d,i)
                        {
                            d3.selectAll("rect").attr("fill", function(d)
                            {
                                if(d=="Next->" || d=="<-Prev") return ("yellow");
                                else return ("red")
                            })

                            d3.select(this)
                                .attr("fill", function(d)
                                {
                                    if(d=="Next->" || d=="<-Prev") return ("yellow");
                                    else return ("blue")
                                })

                            if(d=="Next->"){
                                let year_index = years.indexOf(select_year)
                                if(year_index < (years.length - 2)) select_year = years[year_index+1]
                            }
                            else if(d=="<-Prev")
                            {
                                let year_index = years.indexOf(select_year)
                                if(year_index > 1) select_year = years[year_index-1]
                            }
                            else select_year = Number(d);

                            let id_selected = "#year" + String(select_year)
                            d3.select(id_selected).attr("fill", "blue")

                            plot_points()

                        });
                })

            d3.select('svg')
                .append('g')
                .attr("id", "chart")
                .attr('transform','translate(' + margin + ',' + margin + ')')

            //Filter dataset to be just the year selected
            let select_year_data = data.filter(function(e){return (e.Time==select_year)})

            let chart = d3.select("#chart")


            // Add one dot in the legend for each name.
            chart.selectAll("mydots")
                .data(regions)
                .enter()
                .append("circle")
                .attr("cx", 720)
                .attr("cy", function(d,i){ return 550 + i*20}) // 10 is where the first dot appears. 20 is the distance between dots
                .attr("r", 5)
                .style("fill", function(d){ return cs(d)})

            chart.selectAll("foreignObject")
                .data(regions).enter()
                .append("foreignObject")
                .attr('x', 740)
                .attr('y',  function(d,i){ return 550-10 + i*20})
                .attr('width', 290)
                .attr('height', 20)
                .append("xhtml:tree")
                .html(function(d, i){
                    let s = "<label style='color:" + cs(d)
                        + "'><input type='checkbox' checked=true id='" + d
                        + "' onclick=ARegionClicked(this)>" + d + "</label>"
                    console.log(s)
                    return(s);
                })
                .style("fill", function(d){ return cs(d)})

            //Add circles as points in graph
            chart.selectAll("g")
                .data(select_year_data)
                .enter()
                .append("g")
                .attr("id", function(d){return(d["Country Code"])})
                .attr("transform", function(d, i) {
                    let life_exp = xs(Number(d["Life expectancy at birth, total (years) [SP.DYN.LE00.IN]"]))
                    let gdp =ys(Number(d["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"]))
                    return "translate(" + life_exp + "," + gdp + ")"; })
                .on("mouseover", function(d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html(function(){return(d["Country Name"]
                        + "<br/> GDP = $"+ Math.round(Number(d["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"])))
                    })
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
                .append("circle").attr("r", 3).attr("opacity", 1)
                .attr("fill", function(d, i){return(cs(d["Region"]))})

            //Decide which country codes to show and which to hide to avoid overlapping
            let counter = 0;
            chart.selectAll("g")
                .each(function(d, i)
                {
                    d3.select(this)
                        .append("text").text(function (d, i){
                            let country_code = d["Country Code"]
                            let life_exp = Number(d["Life expectancy at birth, total (years) [SP.DYN.LE00.IN]"])
                            let gdp = Number(d["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"])
                            counter++;
                            if((life_exp>65 & life_exp<85) & (gdp>2000 & gdp<10000)){
                                if(counter%5 != 0) return ("");
                            }
                            if((life_exp>65 & life_exp<85) & (gdp>10000 & gdp<30000)){
                                if(counter%3 != 0) return ("");
                            }
                            if((life_exp>65 & life_exp<85) & (gdp>30000 & gdp<50000)){
                                if(counter%4 != 0) return ("");
                            }
                            if((life_exp>60 & life_exp<65) & (gdp>2000 & gdp<5000)){
                                if(counter%2 != 0) return ("");
                            }
                            if((life_exp>52 & life_exp<60) & (gdp<2000)){
                                if(counter%2 != 0) return ("");
                            }
                            return (country_code)
                        })
                        .attr("font-size", 8)
                        .attr("x", 3)
                        .attr("y", 3)
                })


            /*d3.select("body").selectAll("label").data(regions).enter().append("label").selectAll("input")
                .data(regions)
                .enter()
                .append("input").attr("type", "checkbox")
                .attr("x", 40)
                .attr("y", function(d,i){ return 20 + i*20}) // 10 is where the first dot appears. 20 is the distance between dots
                //.style("fill", function(d){ return cs(d)})
                .text(function(d){ return d})
                .attr("id", function(d){ return d})
                .attr('checked','true')
                //.attr("text-anchor", "left")
                //.style("alignment-baseline", "middle")*/

            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + margin + ")")
                .call(d3.axisLeft(ys).tickFormat(d3.format("~s")))

            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + (margin+svg_dim) + ")")
                .call(d3.axisBottom(xs).tickFormat(d3.format("~s")))

            d3.select("svg").append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .attr("x", 500)
                .attr("y", 1.75*margin+svg_dim)
                .text("Life expectancy at birth, total (years)");

            d3.select("svg").append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("x", -svg_dim/3)
                .attr("y", 20)
                .attr("dy", ".25em")
                .attr("transform", "rotate(-90)")
                .text("GDP per capita, PPP (constant 2017 international $)");

            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations)

        })
        .catch(function(error){
            // handle error
            console.log("in catch error of d3.csv")
            console.log(error)
        })
    }

    function ARegionClicked(object){
        let checked = object.checked
        let clicked_region = object.id

        if (!checked) selected_regions.splice(selected_regions.indexOf(clicked_region),1);
        else selected_regions.push(clicked_region);

        plot_points();
    }

    function plot_points(){

        //d3.select("#chart").selectAll("circle").data(clear_all).exit().remove()
        let cur_x = 0
        let cur_y = 0

        let select_year_data = csv_data.filter(function(e){return (e.Time==select_year)})
        //people.filter((person) => id_filter.includes(Number(person.id)) && person.gender === "m")
        let select_year_region_data = csv_data.filter(({ Region, Time }) => selected_regions.includes(Region) && Time==select_year)

        for(i=0; i<select_year_data.length; i++){
            let life_exp = Number(select_year_data[i]["Life expectancy at birth, total (years) [SP.DYN.LE00.IN]"])
            let gdp = Number(select_year_data[i]["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"]);
            let country = select_year_data[i]["Country Code"]
            let region = select_year_data[i]["Region"]

            const t = d3.transition()
                .duration(2000).delay(100)
                .ease(d3.easeLinear);

            if(selected_regions.indexOf(region)>-1)
                d3.select("#" + country ).attr("opacity",1);
            else
                d3.select("#" + country ).attr("opacity",0);

            d3.select("#" + country ).transition(t)
                .attr("transform", "translate(" + xs(life_exp) + "," + ys(gdp) + ")")

            d3.select("#" + country ).datum(select_year_data[i])
        }
    }


</script>
</body>
</html>
